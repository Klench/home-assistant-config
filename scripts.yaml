################# SONOS #################

##### GROUP/UNGROUP #####

sonos_group_all_speakers:
  alias: Sonos group all speakers
  sequence:
    - service: media_player.volume_set
      data:
        entity_id:
          - media_player.sonos_livingroom
          - media_player.sonos_bedroom
        volume_level: 0.0
    - service: sonos.join
      data:
        master: media_player.sonos_kitchen
        entity_id:
          - media_player.sonos_bedroom
          - media_player.sonos_livingroom
    - service: script.sonos_sync_group_volume

sonos_group_speaker:
  alias: Sonos group speaker
  sequence:
    - service: media_player.volume_set
      data:
        entity_id: "{{ sonos_entity }}"
        volume_level: 0.0
    - service: sonos.join
      data:
        master: media_player.sonos_kitchen
        entity_id: "{{ sonos_entity }}"
    - service: python_script.media_player_volume_set
      data:
        entity_id: "{{ sonos_entity }}"
        volume_level: >
          {{ state_attr('media_player.sonos_kitchen','volume_level') }}

sonos_ungroup_speaker:
  alias: Sonos ungroup speaker
  sequence:
    - service: python_script.media_player_volume_set
      data:
        entity_id: "{{ sonos_entity }}"
        volume_level: 0.01
    - service: sonos.unjoin
      data:
        entity_id: "{{ sonos_entity }}"
    - service: media_player.volume_set
      data:
        entity_id: "{{ sonos_entity }}"
        volume_level: 0.10

sonos_group_livingroom_speaker:
  alias: Sonos group livingroom speaker
  sequence:
    - service: script.sonos_group_speaker
      data:
        sonos_entity: media_player.sonos_livingroom

sonos_group_bedroom_speaker:
  alias: Sonos group bedroom speaker
  sequence:
    - service: script.sonos_group_speaker
      data:
        sonos_entity: media_player.sonos_bedroom

sonos_ungroup_livingroom_speaker:
  alias: Sonos group livingroom speaker
  sequence:
    - service: script.sonos_ungroup_speaker
      data:
        sonos_entity: media_player.sonos_livingroom

sonos_ungroup_bedroom_speaker:
  alias: Sonos group bedroom speaker
  sequence:
    - service: script.sonos_ungroup_speaker
      data:
        sonos_entity: media_player.sonos_bedroom

##### VOLUME #####

sonos_set_group_volume:
  alias: Sonos set group volume
  sequence:
    - service: python_script.media_player_volume_set
      data:
        entity_id: media_player.sonos_kitchen
        set_group_volume: true
        volume_level: '{{ volume }}'

sonos_sync_group_volume:
  alias: Sonos sync group volume
  sequence:
    - service: python_script.media_player_volume_set
      data:
        entity_id: media_player.sonos_kitchen
        set_group_volume: true
        volume_level: >
          {{ state_attr('media_player.sonos_kitchen','volume_level') | float }}

sonos_increase_volume:
  alias: 'Sonos increase volume'
  sequence:
    - service: python_script.media_player_volume_set
      data:
        entity_id: media_player.sonos_kitchen
        set_group_volume: true
        volume_level: >
          {{ [((state_attr('media_player.sonos_kitchen','volume_level') | float * 1.15 + 0.03) | round(2)), 1] | min }}

sonos_decrease_volume:
  alias: 'Sonos decrease volume'
  sequence:
    - service: python_script.media_player_volume_set
      data:
        entity_id: media_player.sonos_kitchen
        set_group_volume: true
        volume_level: >
          {{ [((state_attr('media_player.sonos_kitchen','volume_level') | float * 0.85 - 0.03) | round(2)), 0.05] | max }}

##### SAY #####

sonos_say:
  alias: "Sonos TTS script"
  sequence:
    - service: sonos.snapshot
      data:
        entity_id: "{{ 'media_player.' ~ sonos_entity }}"
    - service: sonos.unjoin
      data:
        entity_id:  "{{ 'media_player.' ~ sonos_entity }}"
    - service: media_player.volume_set
      data:
        entity_id:  "{{ 'media_player.' ~ sonos_entity }}"
        volume_level: "{{ volume }}"
    - service: tts.google_translate_say
      data:
        entity_id:  "{{ 'media_player.' ~ sonos_entity }}"
        message: "{{ message }}"
    - delay: '00:00:01'
    - delay: >
        {% set duration = states.media_player[sonos_entity].attributes.media_duration %}
        {% if duration > 0 %}
          {% set duration = duration - 1 %}
        {% endif %}
        {% set seconds = duration % 60 %}
        {% set minutes = (duration / 60)|int % 60 %}
        {% set hours = (duration / 3600)|int %}
        {{ [hours, minutes, seconds]|join(':') }}
    - service: sonos.restore
      data:
        entity_id:  "{{ 'media_player.' ~ sonos_entity }}"
        with_group: true

##### ALARM #####

sonos_set_alarm:
  alias: 'Sonos set alarm'
  sequence:
    - service: sonos.update_alarm
      data:
        entity_id: media_player.sonos_bedroom
        alarm_id: 7
        time: >
          {{ states('sensor.alarm_clock_time_weekdays') }}
        enabled: true

sonos_disable_alarm:
  alias: 'Sonos disable alarm'
  sequence:
    - service: sonos.update_alarm
      data:
        entity_id: media_player.sonos_bedroom
        alarm_id: 7
        enabled: false

##### NIGHT MODE #####

sonos_enable_night_mode:
  alias: 'Sonos enable night mode'
  sequence:
    - service: sonos.set_option
      data:
         entity_id: media_player.sonos_livingroom
         night_sound: true
         speech_enhance: true

sonos_disable_night_mode:
  alias: 'Sonos disable night mode'
  sequence:
    - service: sonos.set_option
      data:
         entity_id: media_player.sonos_livingroom
         night_sound: false
         speech_enhance: false

################# Lights #################

##### HOME #####

indoor_lights_bright:
  alias: 'Hög ljusstyrka'
  sequence:
    - service: script.turn_on
      target:
        entity_id:
          - script.livingroom_bright
          - script.bedroom_bright
          - script.hallway_bright
          - script.kitchen_bright
          - script.office_bright
    - service: homeassistant.turn_on
      target:
        entity_id: automation.opening_bathroom_door
    - condition: template
      value_template: >
        {{ not (is_state('binary_sensor.sonos_bedroom_is_grouped','off') and is_state('media_player.sonos_bedroom','playing')) }}
    - service: script.childroom_bright

indoor_lights_relaxed:
  alias: 'Mysbelysning'
  sequence:
    - service: script.turn_on
      target:
        entity_id:
          - script.bedroom_relaxed
          - script.childroom_turn_off
          - script.office_relaxed
          - script.livingroom_relaxed
          - script.hallway_relaxed
          - script.kitchen_relaxed
          - script.bathroom_relaxed
    - service: homeassistant.turn_off
      target:
        entity_id: automation.opening_bathroom_door

indoor_lights_low_brightness:
  alias: 'Låg ljusstyrka'
  sequence:
    choose:
      conditions:
        condition: or
        conditions:
          - condition: state
            entity_id: binary_sensor.relaxed_mode
            state: 'on'
          - condition: time
            before: '05:00:00'
      sequence:
        - service: light.turn_off
          target:
            entity_id:
              - light.livingroom_window
              - light.hallway_ceiling_group
        - service: light.turn_on
          data:
            entity_id: light.livingroom_floor
            brightness_pct: 20
            color_temp: 443
            transition: 2
        - service: light.turn_on
          data:
            entity_id: light.kitchen_table
            brightness_pct: 50
            transition: 2
    default:
      - service: script.turn_on
        target:
          entity_id:
            - script.livingroom_low_brightness
            - script.hallway_low_brightness
            - script.kitchen_bright

indoor_lights_off:
  alias: 'Allt släckt'
  sequence:
    - service: light.turn_off
      target:
        entity_id: group.indoor_lights
    - service: homeassistant.turn_on
      data:
        entity_id: automation.opening_bathroom_door
    - service: script.sonos_set_group_volume
      data:
        volume: 0.1

wakeup_lights:
  alias: 'Väckning'
  sequence:
    - service: script.turn_on
      target:
        entity_id:
          - script.bedroom_wakeup
          - script.livingroom_wakeup
          - script.hallway_wakeup
          - script.kitchen_wakeup

window_lights:
  alias: 'Fönsterbelysning'
  sequence:
    - service: light.turn_on
      target:
        entity_id:
          - light.bedroom_bedside
          - light.livingroom_window
          - light.office_window

go_to_bed_lights:
  alias: 'Gå till sängs'
  sequence:
    - service: light.turn_off
      data:
        entity_id: light.bedroom_ceiling
        transition: 300
    - service: light.turn_off
      data:
        entity_id:
          - light.livingroom_ceiling
          - light.livingroom_floor
        transition: 1800
    - delay: '00:30'
    - service: light.turn_off
      data:
        entity_id: light.hallway_ceiling_group

enable_away_lights:
  sequence:
    - delay: '00:00:10'
    - service: script.turn_on
      target:
        entity_id:
          - script.hallway_relaxed
          - script.kitchen_relaxed
          - script.livingroom_relaxed
    - service: light.turn_on
      data:
        entity_id:
          - light.bedroom_bedside
          - light.office_window

watching_tv_lights:
  alias: 'Belysning TV-tittande'
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.livingroom_floor
        brightness: 144
        color_temp: 443
        transition: 2
    - service: light.turn_off
      target:
        entity_id:
          - light.livingroom_ceiling
          - light.livingroom_window

create_indoor_lights_group:
    sequence:
      - service: group.set
        data:
          object_id: "indoor_lights"
          entities: >
            {%- for device in states.light %}{% if 'outdoor' not in device.entity_id %}{%- if loop.first %}{%- else %}, {% endif %}{{ device.entity_id }}{%- if loop.last %}{% endif %}{% endif %}{%- endfor %}

create_all_lights_group:
    sequence:
      - service: group.set
        data:
          object_id: "all_lights"
          entities: >
            {%- for device in states.light %}{%- if loop.first %}{%- else %}, {% endif %}{{ device.entity_id }}{%- if loop.last %}{% endif %}{%- endfor %}

##### BEDROOM #####

bedroom_bright:
  alias: 'Hög ljusstyrka'
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.bedroom_ceiling
        brightness_pct: 80
        transition: 2

bedroom_relaxed:
  alias: 'Mysbelysning'
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.bedroom_ceiling
        brightness_pct: 15
        transition: 2
    - service: light.turn_on
      target:
        entity_id: light.bedroom_bedside

bedroom_wakeup:
  alias: 'Väckning sovrum'
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.bedroom_ceiling
        brightness_pct: 30
        color_temp: 372

##### CHILDREN ROOM #####

childroom_bright:
  alias: 'Hög ljusstyrka'
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.childroom_ceiling
        brightness_pct: 100
        color_temp: 372
        transition: 2

childroom_relaxed:
  alias: 'Mysbelysning'
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.childroom_ceiling
        brightness_pct: 30
        color_temp: 443
        transition: 2

childroom_turn_off:
  alias: 'Släck'
  sequence:
    - service: light.turn_off
      data:
        entity_id: light.childroom_ceiling

##### OFFICE #####

office_bright:
  alias: 'Hög ljusstyrka'
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.office_ceiling
        brightness_pct: 80
        transition: 2
    - service: light.turn_on
      data:
        entity_id: light.office_desk
        brightness_pct: 100
        transition: 2

office_relaxed:
  alias: 'Mysbelysning'
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.office_ceiling
        brightness_pct: 20
    - service: light.turn_on
      data:
        entity_id: light.office_desk
        brightness_pct: 40
        transition: 2
    - service: light.turn_on
      data:
        entity_id: light.office_window
        transition: 2

##### LIVINGROOM #####

livingroom_bright:
  alias: 'Hög ljusstyrka'
  sequence:
    - service: light.turn_on
      data:
        entity_id:
          # - light.livingroom_dinner_table
          - light.livingroom_couch_table
        brightness_pct: 100
        transition: 2
    - service: light.turn_on
      data:
        entity_id: light.livingroom_floor
        brightness_pct: 100
        color_temp: 372
        transition: 2

livingroom_relaxed:
  alias: 'Mysbelysning'
  sequence:
    # - service: light.turn_on
    #   data:
    #     entity_id: light.livingroom_dinner_table
    #     brightness_pct: 40
    #     transition: 2
    - service: light.turn_on
      data:
        entity_id: light.livingroom_couch_table
        brightness_pct: 30
        transition: 2
    - service: light.turn_on
      data:
        entity_id: light.livingroom_floor
        brightness_pct: 40
        color_temp: 443
        transition: 2
    - service: light.turn_on
      target:
        entity_id: light.livingroom_window

livingroom_wakeup:
  alias: 'Väckning vardagsrum'
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.livingroom_floor
        brightness_pct: 100
        color_temp: 372
        transition: 1800

livingroom_low_brightness:
  alias: 'Låg ljusstyrka'
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.livingroom_floor
        brightness_pct: 100
        color_temp: 372
        transition: 2

##### HALLWAY #####

hallway_bright:
  alias: 'Hög ljusstyrka'
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.hallway_ceiling_group
        brightness_pct: 100
        transition: 1
    - delay:
        milliseconds: 1100
    - service: light.turn_on
      data:
        entity_id: light.hallway_ceiling_group
        color_temp: 300
        transition: 1

hallway_low_brightness:
  alias: 'Låg ljusstyrka'
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.hallway_ceiling_bottom_floor
        brightness_pct: 100
        transition: 1
    - delay:
        milliseconds: 1100
    - service: light.turn_on
      data:
        entity_id: light.hallway_ceiling_bottom_floor
        color_temp: 300
        transition: 1

hallway_relaxed:
  alias: 'Mysbelysning'
  sequence:
    - service: light.turn_off
      data:
        entity_id: light.hallway_ceiling_top_floor
        transition: 2
    - service: light.turn_on
      data:
        entity_id: light.hallway_ceiling_bottom_floor
        brightness_pct: 1
        transition: 1
    - delay:
        milliseconds: 1100
    - service: light.turn_on
      data:
        entity_id: light.hallway_ceiling_bottom_floor
        color_temp: 443
        transition: 1

hallway_wakeup:
  alias: 'Väckning hall'
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.hallway_ceiling_bottom_floor
        brightness_pct: 1
        transition: 1
    - delay:
        milliseconds: 1100
    - service: light.turn_on
      data:
        entity_id: light.hallway_ceiling_bottom_floor
        color_temp: 300
        transition: 1
    - delay:
        milliseconds: 1100
    - service: light.turn_on
      data:
        entity_id: light.hallway_ceiling_bottom_floor
        brightness_pct: 100
        transition: 1800

##### KITCHEN #####

kitchen_bright:
  alias: 'Hög ljusstyrka'
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.kitchen_table
        brightness_pct: 100
        transition: 2

kitchen_relaxed:
  alias: 'Mysbelysning'
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.kitchen_table
        brightness_pct: 70
        transition: 2

kitchen_wakeup:
  alias: 'Väckning kök'
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.kitchen_table
        brightness_pct: 100
        transition: 1800

##### BATHROOM #####

bathroom_relaxed:
  alias: 'Badrumsbelysning'
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.bathroom_led
        brightness_pct: 100
        rgb_color: [255,168,38]
        transition: 2
        effect: None

##### OUTDOOR #####

turn_on_outdoor_lights:
  alias: 'Tänd utomhusbelysning'
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.outdoor_main_entrance
        brightness_pct: 100
        transition: 2
    - service: light.turn_on
      data:
        entity_id: light.outdoor_rear_entrance
        brightness_pct: 70
        color_temp: 443
        transition: 2

turn_off_outdoor_lights:
  alias: 'Släck utomhusbelysning'
  sequence:
    - service: light.turn_off
      target:
        entity_id:
          - light.outdoor_main_entrance
          - light.outdoor_rear_entrance

################# ROBOT VACUUM #################

vacuum_clean_home_neato_d7:
  sequence:
    - service: neato.custom_cleaning
      data:
        entity_id: vacuum.neato_d7
        mode: >
          {{ states('sensor.vacuum_mode_neato') }}
        navigation: >
          {{ states('sensor.vacuum_extra_care_neato') }}

vacuum_clean_entrance_neato_d7:
  sequence:
    - service: neato.custom_cleaning
      data:
        entity_id: vacuum.neato_d7
        mode: >
          {{ states('sensor.vacuum_mode_neato') }}
        navigation: >
          {{ states('sensor.vacuum_extra_care_neato') }}
        zone: Entrance

vacuum_clean_kitchen_neato_d7:
  sequence:
    - service: neato.custom_cleaning
      data:
        entity_id: vacuum.neato_d7
        mode: >
          {{ states('sensor.vacuum_mode_neato') }}
        navigation: >
          {{ states('sensor.vacuum_extra_care_neato') }}
        zone: Kitchen

vacuum_clean_livingroom_neato_d7:
  sequence:
    - service: neato.custom_cleaning
      data:
        entity_id: vacuum.neato_d7
        mode: >
          {{ states('sensor.vacuum_mode_neato') }}
        navigation: >
          {{ states('sensor.vacuum_extra_care_neato') }}
        zone: Livingroom

vacuum_clean_hallway_neato_d7:
  sequence:
    - service: neato.custom_cleaning
      data:
        entity_id: vacuum.neato_d7
        mode: >
          {{ states('sensor.vacuum_mode_neato') }}
        navigation: >
          {{ states('sensor.vacuum_extra_care_neato') }}
        zone: Hallway

vacuum_clean_bedroom_neato_d7:
  sequence:
    - service: neato.custom_cleaning
      data:
        entity_id: vacuum.neato_d7
        mode: >
          {{ states('sensor.vacuum_mode_neato') }}
        navigation: >
          {{ states('sensor.vacuum_extra_care_neato') }}
        zone: Bedroom

vacuum_clean_childroom_neato_d7:
  sequence:
    - service: neato.custom_cleaning
      data:
        entity_id: vacuum.neato_d7
        mode: >
          {{ states('sensor.vacuum_mode_neato') }}
        navigation: >
          {{ states('sensor.vacuum_extra_care_neato') }}
        zone: Childroom

vacuum_clean_office_neato_d7:
  sequence:
    - service: neato.custom_cleaning
      data:
        entity_id: vacuum.neato_d7
        mode: >
          {{ states('sensor.vacuum_mode_neato') }}
        navigation: >
          {{ states('sensor.vacuum_extra_care_neato') }}
        zone: Office

################# VARIOUS #################

################# TRANSMISSION #################

transmission_add_torrent:
  alias: 'Lägg till torrent'
  sequence:
    - service: transmission.add_torrent
      data:
        name: Transmission
        torrent: >
          {{ states('input_text.transmission_torrent_url') }}

################# TIMER #################

bedroom_music_timer_start:
  sequence:
    - service: timer.start
      data:
        entity_id: timer.bedroom_music_timer
        duration: >
          {{ states('sensor.bedroom_music_timer_duration') }}

bedroom_music_timer_cancel:
  sequence:
    - service: timer.cancel
      data:
        entity_id: timer.bedroom_music_timer