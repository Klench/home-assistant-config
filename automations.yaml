################# TIME #################

- alias: 'Evening bright'
  trigger:
    platform: sun
    event: sunset
    offset: '-01:00:00'
  condition:
    - condition: state
      entity_id: group.device_tracker_family
      state: 'home'
    - condition: state
      entity_id: binary_sensor.relaxed_mode
      state: 'off'
  action:
    service: script.indoor_lights_bright

- alias: 'Evening relaxed'
  trigger:
    platform: state
    entity_id: binary_sensor.relaxed_mode
    to: 'on'
  condition:
    condition: state
    entity_id: group.device_tracker_family
    state: 'home'
  action:
    - service: script.indoor_lights_relaxed
    - condition: state
      entity_id: binary_sensor.sonos_bedroom_is_grouped
      state: 'on'
    - service: script.sonos_ungroup_bedroom_speaker
    - service: media_player.volume_set
      data:
        entity_id: media_player.sonos_bedroom
        volume_level: 0.15

- alias: 'Hallway bright'
  trigger:
    platform: time
    at: '09:00:00'
  condition:
    - condition: state
      entity_id: group.device_tracker_family
      state: 'home'
    - condition: state
      entity_id: light.hallway_ceiling_group
      state: 'off'
  action:
    service: script.hallway_bright

- alias: 'Advent light'
  trigger:
    platform: time
    at: '09:30:00'
  action:
    - service: light.turn_on
      data:
        entity_id: light.livingroom_window
    - condition: template
      value_template: >
        {{ not (is_state('binary_sensor.sonos_bedroom_is_grouped','off') and is_state('media_player.sonos_bedroom','playing')) }}
    - service: light.turn_on
      data:
        entity_id: light.bedroom_bedside

################# LIGHT AUTOMATIONS FOR SUNSET #################

- alias: 'Sunset'
  initial_state: on
  trigger:
    platform: sun
    event: sunset
  condition:
    - condition: state
      entity_id: group.device_tracker_family
      state: 'home'
    - condition: state
      entity_id: group.indoor_lights
      state: 'on'
  action:
    service: light.turn_on
    target:
      entity_id:
        - light.livingroom_window
        - light.office_window

- alias: 'Bright after sunset bedroom'
  initial_state: on
  trigger:
    platform: state
    entity_id: script.bedroom_bright
    to: 'on'
  condition:
    - condition: sun
      after: sunset
    - condition: state
      entity_id: input_boolean.window_lights_after_sunset
      state: 'on'
  action:
    service: light.turn_on
    target:
      entity_id: light.bedroom_bedside

- alias: 'Bright after sunset livingroom'
  initial_state: on
  trigger:
    platform: state
    entity_id: script.livingroom_bright
    to: 'on'
  condition:
    - condition: sun
      after: sunset
    - condition: state
      entity_id: input_boolean.window_lights_after_sunset
      state: 'on'
  action:
    service: light.turn_on
    target:
      entity_id:
        - light.livingroom_window
        - light.office_window

- alias: 'Outdoor lights at sunset'
  initial_state: on
  trigger:
    platform: sun
    event: sunset
  action:
    service: script.turn_on_outdoor_lights

- alias: 'Outdoor lights at sunrise'
  initial_state: on
  trigger:
    platform: sun
    event: sunrise
  action:
    service: script.turn_off_outdoor_lights
################# WAKEUP #################

- alias: 'Wakeup weekdays'
  trigger:
    platform: state
    entity_id: binary_sensor.alarm_clock_trigger_weekdays
    to: 'on'
  condition:
    condition: or
    conditions:
      - condition: state
        entity_id: input_boolean.wakeup_override
        state: 'on'
      - condition: and
        conditions:
          - condition: state
            entity_id: binary_sensor.workday_sensor
            state: 'on'
          - condition: state
            entity_id: group.device_tracker_family
            state: 'home'
  action:
    service: script.wakeup_lights

- alias: 'Wakeup weekend'
  initial_state: off
  trigger:
    platform: state
    entity_id: binary_sensor.alarm_clock_trigger_weekend
    to: 'on'
  condition:
    - condition: time
      weekday:
        - sat
        - sun
    - condition: state
      entity_id: group.device_tracker_family
      state: 'home'
  action:
    service: script.wakeup_lights

################# AWAY #################

- alias: 'Away turn on lights'
  initial_state: on
  trigger:
    platform: sun
    event: sunset
  condition:
    - condition: state
      entity_id: input_boolean.enable_away_lights
      state: 'on'
    - condition: state
      entity_id: group.device_tracker_family
      state: 'not_home'
  action:
    - service: script.enable_away_lights
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.away_lights_active

- alias: 'Leaving home turn on lights'
  initial_state: on
  trigger:
    platform: state
    entity_id: group.device_tracker_family
    to: 'not_home'
  condition:
    - condition: state
      entity_id: input_boolean.enable_away_lights
      state: 'on'
    - condition: sun
      after: sunset
  action:
    - service: script.enable_away_lights
    - service: input_boolean.turn_on
      data:
        entity_id: input_boolean.away_lights_active

- alias: 'Away turn off lights'
  initial_state: on
  trigger:
    platform: time
    at: '23:30:00'
  condition:
    - condition: state
      entity_id: group.device_tracker_family
      state: 'not_home'
    - condition: state
      entity_id: group.indoor_lights
      state: 'on'
  action:
    - service: script.indoor_lights_off
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.away_lights_active

################# SONOS #################

- alias: 'Enable Sonos alarm'
  trigger:
    platform: time
    at: '03:00:00'
  condition:
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: 'on'
    - condition: state
      entity_id: automation.wakeup_weekdays
      state: 'on'
  action:
    service: script.sonos_set_alarm

- alias: 'Skip song tracks'
  initial_state: on
  trigger:
    platform: template
    value_template: >
      {{ state_attr('media_player.sonos_bedroom','media_title')|regex_search('Perfect', ignorecase=False) }}
  action:
    service: media_player.media_next_track
    data:
      entity_id: media_player.sonos_bedroom

- alias: 'Activate repeat on Sonos bedroom'
  initial_state: on
  trigger:
    platform: state
    entity_id: media_player.sonos_bedroom
    to: 'playing'
    for: "00:00:05"
  condition:
    - condition: state
      entity_id: binary_sensor.sonos_bedroom_is_grouped
      state: 'off'
    - condition: template
      value_template: >
        {{ is_state_attr('media_player.sonos_bedroom','repeat','off') and is_state_attr('media_player.sonos_bedroom','media_content_type','music') }}
  action:
    service: media_player.repeat_set
    data:
      entity_id: media_player.sonos_bedroom
      repeat: all

################# GO TO BED #################

- alias: 'Go to bed weekdays'
  trigger:
    platform: time
    at: '23:00:00'
  condition:
    condition: state
    entity_id: binary_sensor.workday_sensor_offset
    state: 'on'
  action:
    service: script.go_to_bed_lights

- alias: 'Go to bed weekend'
  trigger:
    platform: time
    at: '23:59:00'
  condition:
    condition: time
    weekday:
      - fri
      - sat
  action:
    service: script.go_to_bed_lights

################# IKEA SWITCHES #################

##### BEDROOM #####

- alias: 'Ikea button bedroom on'
  initial_state: on
  trigger:
    platform: event
    event_type: zha_event
    event_data:
      device_id: 9f686575e6ad98784e2efbb0b4e78526
      command: 'on'
  action:
    service: light.turn_on
    data:
      entity_id: light.bedroom_bedside

- alias: 'Ikea button bedroom off'
  initial_state: on
  trigger:
    platform: event
    event_type: zha_event
    event_data:
      device_id: 9f686575e6ad98784e2efbb0b4e78526
      command: 'off'
  action:
    service: light.turn_off
    target:
      entity_id:
        - light.bedroom_ceiling
        - light.bedroom_bedside

##### CHILD ROOM #####

- alias: 'Ikea button childroom toggle'
  initial_state: on
  trigger:
    platform: event
    event_type: zha_event
    event_data:
      device_id: 44bc2855a0757d86e2bf3ca19df7db77
      command: 'toggle'
  action:
    service: light.toggle
    data:
      entity_id: light.childroom_ceiling

- alias: 'Ikea button childroom bright'
  initial_state: on
  trigger:
    platform: event
    event_type: zha_event
    event_data:
      device_id: 44bc2855a0757d86e2bf3ca19df7db77
      command: 'step_with_on_off'
  action:
    service: script.childroom_bright

- alias: 'Ikea button childroom relaxed'
  initial_state: on
  trigger:
    platform: event
    event_type: zha_event
    event_data:
      device_id: 44bc2855a0757d86e2bf3ca19df7db77
      command: 'step'
  action:
    service: script.childroom_relaxed

- alias: 'Ikea button childroom increase volume'
  initial_state: on
  trigger:
    platform: event
    event_type: zha_event
    event_data:
      device_id: 44bc2855a0757d86e2bf3ca19df7db77
      command: 'press'
      args: [256, 13, 0]
  action:
    service: python_script.media_player_volume_set
    data:
      entity_id: media_player.sonos_bedroom
      volume_level: >
        {{ [((state_attr('media_player.sonos_bedroom','volume_level') | float * 1.15 + 0.03) | round(2)), 1] | min }}

- alias: 'Ikea button childroom decrease volume'
  initial_state: on
  trigger:
    platform: event
    event_type: zha_event
    event_data:
      device_id: 44bc2855a0757d86e2bf3ca19df7db77
      command: 'press'
      args: [257, 13, 0]
  action:
    service: python_script.media_player_volume_set
    data:
      entity_id: media_player.sonos_bedroom
      volume_level: >
        {{ [((state_attr('media_player.sonos_bedroom','volume_level') | float * 0.85 - 0.03) | round(2)), 0.05] | max }}

- alias: 'Ikea button childroom ungroup speaker'
  initial_state: on
  trigger:
    platform: event
    event_type: zha_event
    event_data:
      device_id: 44bc2855a0757d86e2bf3ca19df7db77
      command: 'hold'
      args: [3329, 0]
  action:
    service: script.sonos_ungroup_bedroom_speaker

- alias: 'Ikea button childroom group speaker'
  initial_state: on
  trigger:
    platform: event
    event_type: zha_event
    event_data:
      device_id: 44bc2855a0757d86e2bf3ca19df7db77
      command: 'hold'
      args: [3328, 0]
  action:
    service: script.sonos_group_bedroom_speaker

##### HALLWAY TOP FLOOR #####

- alias: 'Ikea switch low brightbess'
  initial_state: on
  trigger:
    platform: event
    event_type: zha_event
    event_data:
      device_id: 3b531df34853b38343b729aacef15e48
      command: 'on'
  action:
    service: script.indoor_lights_low_brightness

- alias: 'Ikea switch turn off indoor lights'
  initial_state: on
  trigger:
    platform: event
    event_type: zha_event
    event_data:
      device_id: 3b531df34853b38343b729aacef15e48
      command: 'off'
  action:
    service: script.indoor_lights_off

################# SHELLY SWITCHES #################

##### LIVINGROOM #####

- alias: 'Shelly livingroom relaxed'
  initial_state: on
  trigger:
    platform: event
    event_type: shelly_switch_click
    event_data:
      entity_id: 'binary_sensor.shelly_livingroom_2_switch'
      click_cnt: 2
      state: false
  condition:
    condition: template
    value_template: >
      {{ is_state('light.livingroom_couch_table','off') or is_state_attr('light.livingroom_couch_table','brightness',255) }}
  action:
    service: script.livingroom_relaxed

- alias: 'Shelly livingroom bright'
  initial_state: on
  trigger:
    platform: event
    event_type: shelly_switch_click
    event_data:
      entity_id: 'binary_sensor.shelly_livingroom_2_switch'
      click_cnt: 2
      state: false
  condition:
    condition: template
    value_template: >
      {{ is_state_attr('light.livingroom_couch_table','brightness',76) }}
  action:
    service: script.livingroom_bright

- alias: 'Shelly livingroom bright long press'
  initial_state: on
  trigger:
    platform: event
    event_type: shellyforhass.click
    event_data:
      entity_id: 'binary_sensor.shelly_livingroom_2_switch'
      click_type: 'long'
  condition:
    condition: state
    entity_id: light.livingroom_couch_table
    state: 'off'
  action:
    service: script.livingroom_bright

- alias: 'Shelly livingroom turn off lights'
  initial_state: on
  trigger:
    platform: event
    event_type: shellyforhass.click
    event_data:
      entity_id: 'binary_sensor.shelly_livingroom_2_switch'
      click_type: 'long'
  action:
    service: light.turn_off
    target:
      entity_id:
        - light.livingroom_couch_table
        - light.livingroom_window
        - light.livingroom_floor

################# HUE SWITCH #################

##### LIGHTS #####

- alias: 'Hue switch bright'
  initial_state: on
  trigger:
    platform: state
    entity_id: sensor.hue_hallway_switch
  condition:
    condition: state
    entity_id: sensor.hue_hallway_switch
    state: '1_click_up'
  action:
    service: script.indoor_lights_bright

- alias: 'Hue switch relaxed'
  initial_state: on
  trigger:
    platform: state
    entity_id: sensor.hue_hallway_switch
  condition:
    condition: state
    entity_id: sensor.hue_hallway_switch
    state: '1_hold_up'
  action:
    - service: script.indoor_lights_relaxed
    - condition: state
      entity_id: binary_sensor.sonos_bedroom_is_grouped
      state: 'on'
    - service: script.sonos_ungroup_bedroom_speaker
    - service: media_player.volume_set
      data:
        entity_id: media_player.sonos_bedroom
        volume_level: 0.2

- alias: 'Hue switch turn off lighs'
  initial_state: on
  trigger:
    platform: state
    entity_id: sensor.hue_hallway_switch
  condition:
    condition: state
    entity_id: sensor.hue_hallway_switch
    state: '4_click_up'
  action:
    service: script.indoor_lights_off

- alias: 'Hue switch low brightness'
  initial_state: on
  trigger:
    platform: state
    entity_id: sensor.hue_hallway_switch
  condition:
    condition: state
    entity_id: sensor.hue_hallway_switch
    state: '4_hold_up'
  action:
    service: script.indoor_lights_low_brightness

##### SONOS #####

- alias: 'Hue switch group livingroom speaker'
  initial_state: on
  trigger:
    platform: state
    entity_id: sensor.hue_hallway_switch
  condition:
    - condition: state
      entity_id: sensor.hue_hallway_switch
      state: '2_hold_up'
    - condition: state
      entity_id: binary_sensor.sonos_livingroom_is_grouped
      state: 'off'
  action:
    service: script.sonos_group_livingroom_speaker

- alias: 'Hue switch ungroup livingroom speaker'
  initial_state: on
  trigger:
    platform: state
    entity_id: sensor.hue_hallway_switch
  condition:
    - condition: state
      entity_id: sensor.hue_hallway_switch
      state: '2_hold_up'
    - condition: state
      entity_id: binary_sensor.sonos_livingroom_is_grouped
      state: 'on'
  action:
    service: script.sonos_ungroup_livingroom_speaker

- alias: 'Hue switch group bedroom speaker'
  initial_state: on
  trigger:
    platform: state
    entity_id: sensor.hue_hallway_switch
  condition:
    - condition: state
      entity_id: sensor.hue_hallway_switch
      state: '3_hold_up'
    - condition: state
      entity_id: binary_sensor.sonos_bedroom_is_grouped
      state: 'off'
  action:
    service: script.sonos_group_bedroom_speaker

- alias: 'Hue switch ungroup bedroom speaker'
  initial_state: on
  trigger:
    platform: state
    entity_id: sensor.hue_hallway_switch
  condition:
    - condition: state
      entity_id: sensor.hue_hallway_switch
      state: '3_hold_up'
    - condition: state
      entity_id: binary_sensor.sonos_bedroom_is_grouped
      state: 'on'
  action:
    service: script.sonos_ungroup_bedroom_speaker

- alias: 'Hue switch increase Sonos group volume'
  initial_state: on
  trigger:
    platform: state
    entity_id: sensor.hue_hallway_switch
  condition:
    - condition: state
      entity_id: sensor.hue_hallway_switch
      state: '2_click_up'
    - condition: or
      conditions:
        - condition: state
          entity_id: media_player.sonos_bedroom
          state:
            - 'paused'
            - 'idle'
        - condition: state
          entity_id: binary_sensor.sonos_bedroom_is_grouped
          state: 'on'
  action:
    service: script.sonos_increase_volume

- alias: 'Hue switch decrease Sonos group volume'
  initial_state: on
  trigger:
    platform: state
    entity_id: sensor.hue_hallway_switch
  condition:
    - condition: state
      entity_id: sensor.hue_hallway_switch
      state: '3_click_up'
    - condition: or
      conditions:
        - condition: state
          entity_id: media_player.sonos_bedroom
          state:
            - 'paused'
            - 'idle'
        - condition: state
          entity_id: binary_sensor.sonos_bedroom_is_grouped
          state: 'on'
  action:
    service: script.sonos_decrease_volume

- alias: 'Hue switch increase Sonos bedroom volume'
  initial_state: on
  trigger:
    platform: state
    entity_id: sensor.hue_hallway_switch
  condition:
    - condition: state
      entity_id: sensor.hue_hallway_switch
      state: '2_click_up'
    - condition: state
      entity_id: media_player.sonos_kitchen
      state:
        - 'paused'
        - 'idle'
    - condition: state
      entity_id: media_player.sonos_bedroom
      state: 'playing'
    - condition: state
      entity_id: binary_sensor.sonos_bedroom_is_grouped
      state: 'off'
  action:
    service: python_script.media_player_volume_set
    data:
      entity_id: media_player.sonos_bedroom
      volume_level: >
        {{ [((state_attr('media_player.sonos_bedroom','volume_level') | float * 1.15 + 0.03) | round(2)), 1] | min }}

- alias: 'Hue switch decrease Sonos bedroom volume'
  initial_state: on
  trigger:
    platform: state
    entity_id: sensor.hue_hallway_switch
  condition:
    - condition: state
      entity_id: sensor.hue_hallway_switch
      state: '3_click_up'
    - condition: state
      entity_id: media_player.sonos_kitchen
      state:
        - 'paused'
        - 'idle'
    - condition: state
      entity_id: media_player.sonos_bedroom
      state: 'playing'
    - condition: state
      entity_id: binary_sensor.sonos_bedroom_is_grouped
      state: 'off'
  action:
    service: python_script.media_player_volume_set
    data:
      entity_id: media_player.sonos_bedroom
      volume_level: >
        {{ [((state_attr('media_player.sonos_bedroom','volume_level') | float * 0.85 - 0.03) | round(2)), 0.05] | max }}

##### POLLING INTERVAL #####

- alias: 'Set Hue polling interval'
  initial_state: on
  trigger:
    platform: homeassistant
    event: start
  action:
    service: fasthue.set_update_interval
    entity_id: sensor.hue_polling_interval
    data:
      scan_interval:
        seconds: 1

################# LEAVING/COMING HOME #################

- alias: 'Leaving home'
  initial_state: on
  trigger:
    platform: state
    entity_id: group.device_tracker_family
    to: 'not_home'
  action:
    service: script.indoor_lights_off

- alias: 'Leaving home pause Sonos'
  initial_state: on
  trigger:
    platform: state
    entity_id: group.device_tracker_family
    to: 'not_home'
  condition:
    condition: state
    entity_id: media_player.sonos_kitchen
    state: 'playing'
  action:
    service: media_player.media_pause
    entity_id: media_player.sonos_kitchen

- alias: 'Coming home turn on lights bright'
  initial_state: on
  trigger:
    - platform: state
      entity_id: group.device_tracker_family
      to: 'home'
    - platform: state
      entity_id: device_tracker.volvo_lgd321
      to: 'home'
  condition:
    - condition: state
      entity_id: input_boolean.coming_home_turn_on_lights
      state: 'on'
    - condition: state
      entity_id: binary_sensor.relaxed_mode
      state: 'off'
    - condition: sun
      after: sunset
      after_offset: '-01:00:00'
    - condition: or
      conditions:
        - condition: state
          entity_id: group.indoor_lights
          state: 'off'
        - condition: state
          entity_id: input_boolean.away_lights_active
          state: 'on'
  action:
    - service: script.indoor_lights_bright
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.away_lights_active

- alias: 'Coming home turn on lights relaxed'
  initial_state: on
  trigger:
    - platform: state
      entity_id: group.device_tracker_family
      to: 'home'
    - platform: state
      entity_id: device_tracker.volvo_lgd321
      to: 'home'
  condition:
    - condition: state
      entity_id: input_boolean.coming_home_turn_on_lights
      state: 'on'
    - condition: state
      entity_id: binary_sensor.relaxed_mode
      state: 'on'
    - condition: sun
      after: sunset
      after_offset: '-01:00:00'
    - condition: or
      conditions:
        - condition: state
          entity_id: group.indoor_lights
          state: 'off'
        - condition: state
          entity_id: input_boolean.away_lights_active
          state: 'on'
  action:
    - service: script.indoor_lights_relaxed
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.away_lights_active

- alias: 'Coming home turn on hallway lights'
  initial_state: on
  trigger:
    - platform: state
      entity_id: group.device_tracker_family
      to: 'home'
    - platform: state
      entity_id: device_tracker.volvo_lgd321
      to: 'home'
    - platform: state
      entity_id: device_tracker.sela_ltjs4sl13
      to: 'home'
  condition:
    - condition: state
      entity_id: input_boolean.coming_home_turn_on_lights
      state: 'on'
    - condition: state
      entity_id: binary_sensor.relaxed_mode
      state: 'off'
    - condition: sun
      before: sunset
      before_offset: '-01:00:00'
    - condition: sun
      after: sunrise
      after_offset: '01:00:00'
    - condition: or
      conditions:
        - condition: state
          entity_id: group.indoor_lights
          state: 'off'
        - condition: state
          entity_id: input_boolean.away_lights_active
          state: 'on'
  action:
    - service: script.hallway_bright
    - service: input_boolean.turn_off
      data:
        entity_id: input_boolean.away_lights_active

- alias: 'Coming home group Sonos speakers'
  initial_state: on
  trigger:
    platform: state
    entity_id: group.device_tracker_family
    to: 'home'
  condition:
    condition: state
    entity_id: binary_sensor.sonos_livingroom_tv_active
    state: 'off'
  action:
    - choose:
        - conditions:
            - condition: state
              entity_id: binary_sensor.relaxed_mode
              state: 'on'
          sequence:
            - service: script.sonos_group_livingroom_speaker
            - service: script.sonos_set_group_volume
              data:
                volume: 0.2
            - service: script.sonos_ungroup_bedroom_speaker
            - service: media_player.volume_set
              data:
                entity_id: media_player.sonos_bedroom
                volume_level: 0.2
      default:
        - service: script.sonos_group_all_speakers
        - service: script.sonos_set_group_volume
          data:
            volume: 0.2

- alias: 'Nellie coming home'
  initial_state: on
  trigger:
    platform: state
    entity_id: device_tracker.volvo_lgd321
    to: 'home'
  condition:
    - condition: state
      entity_id: device_tracker.nellies_iphone
      state: 'not_home'
    - condition: state
      entity_id: device_tracker.davids_iphone
      state: 'home'
  action:
    service: light.turn_on
    data:
      entity_id: light.kitchen_table
      flash: short

################# OFFICE #################

- alias: 'Start working'
  initial_state: on
  trigger:
    platform: state
    entity_id: device_tracker.sela_ltjs4sl13
    to: 'home'
  action:
    service: script.office_bright

################# MEDIA #################

- alias: 'Watching TV'
  trigger:
    platform: state
    entity_id: media_player.plex_vardagsrum
    to: 'playing'
  condition:
    condition: and
    conditions:
      - condition: or
        conditions:
          - condition: time
            after: '20:30:00'
          - condition: time
            before: '10:00:00'
      - condition: or
        conditions:
          - condition: sun
            after: sunset
            after_offset: '-01:00:00'
          - condition: sun
            before: sunrise
            before_offset: '1:00:00'
  action:
    service: script.watching_tv_lights

- alias: 'TV off group speakers'
  initial_state: on
  trigger:
    platform: state
    entity_id: binary_sensor.sonos_livingroom_tv_active
    to: 'off'
  condition:
    condition: not
    conditions:
      - condition: state
        entity_id: binary_sensor.sonos_livingroom_is_grouped
        state: 'on'
      - condition: state
        entity_id: media_player.sonos_livingroom
        state: 'playing'
  action:
    service: script.sonos_group_livingroom_speaker

- alias: 'TV off disable night mode'
  initial_state: on
  trigger:
    platform: state
    entity_id: media_player.tv_custom
    to: 'off'
  condition:
    condition: state
    entity_id: binary_sensor.sonos_night_mode
    state: 'on'
  action:
    service: script.sonos_disable_night_mode

################# CAR HEATER #################

- alias: 'Car heater weekdays'
  initial_state: off
  trigger:
    platform: state
    entity_id: binary_sensor.car_heater_trigger_workdays
    to: 'on'
  condition:
    - condition: numeric_state
      entity_id: sensor.outdoor_temperature
      below: 3
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: 'on'
    - condition: state
      entity_id: group.device_tracker_family
      state: 'home'
    - condition: state
      entity_id: switch.lgd321_heater
      state: 'off'
  action:
    - service: switch.turn_on
      entity_id: switch.lgd321_heater

- alias: 'Car heater audio notification'
  initial_state: on
  trigger:
    platform: state
    entity_id: switch.lgd321_heater
    to: 'on'
  condition:
    condition: state
    entity_id: device_tracker.davidsiphone
    state: 'home'
  action: 
    service: script.sonos_say
    data:
      sonos_entity: kok
      volume: 0.1
      message: 'Car heater turned on'

################# TRANSMISSION #################

- alias: 'Transmission add torrent'
  initial_state: on
  trigger:
    platform: state
    entity_id: input_text.transmission_torrent_url
  action:
    - service: script.transmission_add_torrent

################# TIMER #################

- alias: 'Pause bedroom music'
  initial_state: on
  trigger:
    platform: event
    event_type: timer.finished
    event_data:
      entity_id: timer.bedroom_music_timer
  condition:
    - condition: state
      entity_id: media_player.sonos_bedroom
      state: 'playing'
    - condition: state
      entity_id: binary_sensor.sonos_bedroom_is_grouped
      state: 'off'
  action:
    - service: python_script.media_player_volume_set
      data:
        entity_id: media_player.sonos_bedroom
        volume_level: 0.01
    - service: media_player.media_pause
      entity_id: media_player.sonos_bedroom
    - service: media_player.volume_set
      data:
        entity_id: media_player.sonos_bedroom
        volume_level: 0.10

- alias: 'Start bedroom music timer'
  initial_state: on
  trigger:
    platform: state
    entity_id: script.indoor_lights_off
    to: 'on'
  condition:
    - condition: state
      entity_id: media_player.sonos_bedroom
      state: 'playing'
    - condition: state
      entity_id: binary_sensor.sonos_bedroom_is_grouped
      state: 'off'
    - condition: state
      entity_id: binary_sensor.relaxed_mode
      state: 'on'
  action:
    service: script.bedroom_music_timer_start

################# NOTIFICATIONS #################

##### CAR HEATER #####

- alias: 'Car heater start'
  initial_state: on
  trigger:
    platform: state
    entity_id: switch.lgd321_heater
    to: 'on'
  condition:
    condition: state
    entity_id: device_tracker.volvo_lgd321
    state: 'home'
  action:
    service: notify.mobile_app_davids_iphone
    data:
      message: 'Parkeringsvärmaren har startats'
      title: 'Volvo V60'
      data:
        push:
          category: 'carheater'

##### ALARM #####

- alias: 'Alarm not active'
  initial_state: on
  trigger:
    platform: state
    entity_id: group.device_tracker_family
    to: 'not_home'
    for: "00:30:00"
  condition:
    condition: template
    value_template: >
      {{ not is_state('alarm_control_panel.ajax_alarm_status','armed_away') }}
  action:
    choose:
      - conditions: >
          {{ states.device_tracker.davids_iphone.last_changed > states.device_tracker.nellies_iphone.last_changed }}
        sequence:
          - service: notify.mobile_app_davids_iphone
            data:
              message: 'Larmet är ej aktiverat'
              title: 'Larmstatus'
              data:
                push:
                  category: 'alarmstatus'
                sound:
                  name: default
                  critical: 1
                  volume: 0.5
      - conditions: >
          {{ states.device_tracker.davids_iphone.last_changed < states.device_tracker.nellies_iphone.last_changed }}
        sequence:
          - service: notify.mobile_app_nellies_iphone
            data:
              message: 'Larmet är ej aktiverat'
              title: 'Larmstatus'
              data:
                push:
                  category: 'alarmstatus'
                sound:
                  name: default
                  critical: 1
                  volume: 0.5

- alias: 'Night mode not active'
  initial_state: on
  trigger:
    platform: state
    entity_id: script.indoor_lights_off
    to: 'on'
  condition:
    - condition: state
      entity_id: group.device_tracker_family
      state: 'home'
      for: "00:00:05"
    - condition: state
      entity_id: binary_sensor.relaxed_mode
      state: 'on'
    - condition: template
      value_template: >
        {{ not is_state('alarm_control_panel.ajax_alarm_status','armed_night') }}
  action:
    service: notify.mobile_app_davids_iphone
    data:
      message: 'Nattläge är ej aktiverat'
      title: 'Larmstatus'
      data:
        push:
          category: 'alarmstatus'
        sound:
          name: default
          critical: 1
          volume: 0.1

################# IOS EVENTS #################

- alias: 'Toggle kitchen relay'
  initial_state: on
  trigger:
    platform: event
    event_type: ios.action_fired
    event_data:
      actionID: F2398A0D-8A0C-41BA-B337-1405B6518531
      actionName: Toggle kitchen relay
      sourceDeviceID: davids_iphone
      sourceDeviceName: Davids iPhone
      sourceDevicePermanentID: CFD2DEC1-8CF3-432F-AF78-7419632CC842
      triggerSource: siriShortcut
  action:
    service: switch.toggle
    target:
      entity_id: switch.kitchen_relay

- alias: 'Play child room music'
  initial_state: on
  trigger:
    platform: event
    event_type: ios.action_fired
    event_data:
      actionID: CADF83CD-087C-4737-8E5F-16D3DB61E40E
      actionName: Play child room music
      sourceDeviceID: davids_iphone
      sourceDeviceName: Davids iPhone
      sourceDevicePermanentID: CFD2DEC1-8CF3-432F-AF78-7419632CC842
      triggerSource: siriShortcut
  action:
    - service: light.turn_off
      target:
        entity_id: light.childroom_ceiling
    - choose:
      - conditions: >
          {{ is_state('binary_sensor.sonos_bedroom_is_grouped','on') }}
        sequence:
          - service: python_script.media_player_volume_set
            data:
              entity_id: media_player.sonos_bedroom
              volume_level: 0
          - service: script.sonos_ungroup_bedroom_speaker
          - service: media_player.volume_set
            data:
              entity_id: media_player.sonos_bedroom
              volume_level: 0.1
          - delay: '00:00:01'
          - service: media_player.media_play
            target:
              entity_id: media_player.sonos_bedroom
      default:
        - service: media_player.volume_set
          data:
            entity_id: media_player.sonos_bedroom
            volume_level: 0.1
        - delay: '00:00:01'
        - service: media_player.media_play
          target:
            entity_id: media_player.sonos_bedroom

################# CREATE LIGHT GROUPS #################

- alias: 'Create light groups'
  initial_state: on
  trigger:
    platform: homeassistant
    event: start
  action:
    - service: script.create_indoor_lights_group
    - service: script.create_all_lights_group