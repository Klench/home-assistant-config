################# CAR HEATER #################

- alias: 'Car heater start'
  initial_state: on
  trigger:
    platform: state
    entity_id: switch.rcb492_heater
    to: 'on'
  condition:
    - condition: state
      entity_id: device_tracker.rcb492
      state: 'not_home'
    - condition: state
      entity_id: person.david
      state: 'not_home'
  action:
    service: notify.mobile_app_davids_iphone
    data:
      title: 'Volvo V60'
      message: 'Parkeringsvärmaren har startat'

- alias: 'Car heater audio notification'
  initial_state: on
  trigger:
    platform: state
    entity_id: switch.rcb492_heater
    to: 'on'
  condition:
    - condition: state
      entity_id: device_tracker.rcb492
      state: 'home'
    - condition: state
      entity_id: person.david
      state: 'home'
  action:
    service: script.sonos_tts
    data:
      entity_id: media_player.kitchen_sonos
      volume: 0.1
      message: 'Parkeringsvärmaren har startat'

################# ALARM #################

- alias: 'Alarm not active'
  initial_state: on
  trigger:
    platform: state
    entity_id: group.device_tracker_family
    to: 'not_home'
    for: "00:30:00"
  condition:
    condition: template
    value_template: >
      {{ not is_state('alarm_control_panel.ajax_alarm_status','armed_away') }}
  action:
    choose:
      - conditions: >
          {{ states.person.david.last_changed > states.person.nellie.last_changed }}
        sequence:
          - service: notify.mobile_app_davids_iphone
            data:
              message: 'Larmet är ej aktiverat'
              title: 'Larmstatus'
              data:
                sound:
                  name: default
                  critical: 1
                  volume: 0.5
      - conditions: >
          {{ states.person.david.last_changed < states.person.nellie.last_changed }}
        sequence:
          - service: notify.mobile_app_nellies_iphone
            data:
              message: 'Larmet är ej aktiverat'
              title: 'Larmstatus'
              data:
                sound:
                  name: default
                  critical: 1
                  volume: 0.5

- alias: 'Night mode not active'
  initial_state: on
  trigger:
    platform: state
    entity_id: script.indoor_lights_off
    to: 'on'
  condition:
    - condition: state
      entity_id: group.device_tracker_family
      state: 'home'
      for: "00:00:05"
    - condition: state
      entity_id: binary_sensor.relaxed_mode
      state: 'on'
    - condition: template
      value_template: >
        {{ not is_state('alarm_control_panel.ajax_alarm_status','armed_night') }}
  action:
    service: notify.mobile_app_davids_iphone
    data:
      title: 'Larmstatus'
      message: 'Nattläge är ej aktiverat'
      data:
        sound:
          name: default
          critical: 1
          volume: 0.1

################# CCTV #################

- alias: 'Person detected notify Davids iPhone'
  trigger:
    platform: state
    entity_id: sensor.asgari_1_person_count
  condition:
    condition: template
    value_template: '{{ trigger.to_state.state | int > trigger.from_state.state | int }}'
  action:
    service: notify.mobile_app_davids_iphone
    data:
      title: 'Övervakningskamera'
      message: 'Person detekterad'
      data:
        url: "/lovelace/2"
        push:
          sound:
            name: US-EN-Morgan-Freeman-Motion-Detected.wav
            critical: 1
            volume: 0.8

- alias: 'Person detected notify Nellies iPhone'
  trigger:
    platform: state
    entity_id: sensor.asgari_1_person_count
  condition:
    condition: template
    value_template: '{{ trigger.to_state.state | int > trigger.from_state.state | int }}'
  action:
    service: notify.mobile_app_nellies_iphone
    data:
      title: 'Övervakningskamera'
      message: 'Person detekterad'
      data:
        url: "/lovelace/2"
        push:
          sound:
            name: US-EN-Morgan-Freeman-Motion-Detected.wav
            critical: 1
            volume: 0.8

- alias: 'Person detected notify Sonos'
  trigger:
    platform: state
    entity_id: sensor.asgari_1_person_count
  condition:
    condition: template
    value_template: '{{ trigger.to_state.state | int > trigger.from_state.state | int }}'
  action:
    service: script.sonos_play_local_media
    data:
      entity_id: media_player.livingroom_sonos
      media_filename: "US-EN-Morgan-Freeman-Motion-Detected.mp3"
      volume: 0.3